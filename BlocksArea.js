"use strict";const sum=t=>t.reduce(((t,e)=>t+e),0),default_elements={INPUT:{inputs:[],outputs:["x"],inputs_groups:[],outputs_groups:[1]},OUTPUT:{inputs:["x"],outputs:[],inputs_groups:[1],outputs_groups:[]},NOT:{inputs:["x"],outputs:["!x"],inputs_groups:[1],outputs_groups:[1]},AND:{inputs:["x","y"],outputs:["x && y"],inputs_groups:[1,1],outputs_groups:[1]},OR:{inputs:["x","y"],outputs:["x || y"],inputs_groups:[1,1],outputs_groups:[1]}};function scalePoint(t,e){return{x:t.x*e,y:t.y*e}}function getUniqueId(t){return 0==Object.keys(t).length?0:Math.max(...Object.keys(t))+1}function joinWithNext(t,e){return t.length>e+1&&(t[e]+=t[e+1],t.splice(e+1,1)),t}function unjoinToNext(t,e){return t[e]>1&&(t[e]-=1,t.splice(e+1,0,1)),t}function cutToSum(t,e){const s=[];let n=e;for(let e of t){if(0==n)break;e>n&&(e=n),n-=e,s.push(e)}for(let t=0;t<n;t++)s.push(1);return s}function numberOr(t,e){return t=Number.parseInt(t,10),isNaN(t)?e:t}function deepCopy(t){return JSON.parse(JSON.stringify(t))}class BlocksArea extends preact.Component{constructor(){super(),this.state={name:"test",custom_elements:{},new_element:{type:"new",inputs:[""],outputs:[""],inputs_groups:[1],outputs_groups:[1]},inputs_number:0,outputs_number:0,blocks:{},wires:{},adding_wire:!1,adding_wire_info:void 0,dragging_block:!1,scale:1,offset:{x:0,y:0},dragging_scheme:!1,dragging_scheme_from_point:void 0,tests_editor_opened:!1,tests:[]},this.onBlockStateChange=this.onBlockStateChange.bind(this),this.onBlockMounted=this.onBlockMounted.bind(this),this.onBlockStopInitialDragging=this.onBlockStopInitialDragging.bind(this),this.save=this.save.bind(this),this.load=this.load.bind(this),this.export=this.export.bind(this),this.clear=this.clear.bind(this),this.handleMouseDown=this.handleMouseDown.bind(this),this.handleMouseDownOnSchemeArea=this.handleMouseDownOnSchemeArea.bind(this),this.handleMouseMove=this.handleMouseMove.bind(this),this.handleMouseUp=this.handleMouseUp.bind(this),this.startAddingWire=this.startAddingWire.bind(this),this.handleMouseUpOnInputOutput=this.handleMouseUpOnInputOutput.bind(this),this.handleAddBlockButtonClick=this.handleAddBlockButtonClick.bind(this),this.handleMouseWheel=this.handleMouseWheel.bind(this),this.removeWires=this.removeWires.bind(this),this.getTypeInfo=this.getTypeInfo.bind(this),this._ref=preact.createRef(),this.inputs_number_ref=preact.createRef(),this.outputs_number_ref=preact.createRef(),this.state.blocks_wrapper_ref=preact.createRef()}componentDidMount(){this.state.event_listeners=[[this.inputs_number_ref.current,"wheel",t=>{t.preventDefault();const e=-Math.sign(t.deltaY);this.setState((t=>{const s=t.new_element.inputs.length+e;return s<1||(t.new_element.inputs=filledArray(s,""),t.new_element.inputs_groups=cutToSum(t.new_element.inputs_groups,s)),t}))}],[this.outputs_number_ref.current,"wheel",t=>{t.preventDefault();const e=-Math.sign(t.deltaY);this.setState((t=>{const s=numberOr(t.new_element.outputs.length,1)+e;return s<1||(t.new_element.outputs=filledArray(s,""),t.new_element.outputs_groups=cutToSum(t.new_element.outputs_groups,s)),t}))}],[this._ref.current,"drag",t=>t.preventDefault()],[this._ref.current,"dragstart",t=>t.preventDefault()],[this._ref.current,"dragend",t=>t.preventDefault()],[this._ref.current,"dragover",t=>t.preventDefault()],[this._ref.current,"dragenter",t=>t.preventDefault()],[this._ref.current,"dragleave",t=>t.preventDefault()],[this._ref.current,"drop",t=>t.preventDefault()]];for(const t of this.state.event_listeners)t[0].addEventListener(t[1],t[2])}componentWillUnmount(){for(const t of this.state.event_listeners)t[0].removeEventListener(t[1],t[2])}add(t,e){this.setState((e=>{if(!("blocks"in t))return e;for(const s of t.blocks){const t=Object.values(e.blocks).map((t=>t.const_id)),n=0==t.length?1:Math.max(...t)+1;if(null!=e.blocks[n])return e;if("INPUT"==s.type)s.id=s.type+" "+(e.inputs_number+1),e.inputs_number+=1;else if("OUTPUT"==s.type)s.id=s.type+" "+(e.outputs_number+1),e.outputs_number+=1;else{const t=Object.fromEntries(Object.entries(this.state.blocks).filter((([t,e])=>e.type==s.type)));s.id=s.type+" "+(Object.keys(t).length+1)}s.const_id=n,e.blocks[n]=s}return e}),(()=>{"wires"in t&&(this.render(),this.setState((s=>{for(const n of t.wires){const t=getUniqueId(s.wires);s.wires[t]={id:t,from_block_const_id:String(n.from_block_const_id),to_block_const_id:String(n.to_block_const_id),from_output_id:n.from_output_id,to_input_id:n.to_input_id};const o=s.blocks[n.to_block_const_id],i=s.blocks[n.from_block_const_id];s.blocks[n.to_block_const_id]=o.getInfo(),s.blocks[n.from_block_const_id]=i.getInfo(),this.updateWireCoordinates(s,t,e,!0)}return s})))}))}updateWireCoordinates(t,e,s,n=!0){const o=t.wires[e],i=t.blocks[o.from_block_const_id],a=t.blocks[o.to_block_const_id],r=(this._ref.current.parentElement.getBoundingClientRect(),this.state.scale),u=n?t=>({x:t.x/r,y:t.y/r}):t=>t;"to"!=s&&(o.from_point=u(i.output_connectors_coordinates[o.from_output_id])),"from"!=s&&(o.to_point=u(a.input_connectors_coordinates[o.to_input_id])),t.wires[e]=o}onBlockMounted(t){this.setState((e=>(e.blocks[t.const_id]=Object.assign(t),e)))}onBlockStateChange(t){this.setState((e=>(e.blocks[t.const_id]=t,Object.values(e.wires).forEach((s=>{t.const_id==s.from_block_const_id?this.updateWireCoordinates(e,s.id,"from",!0):t.const_id==s.to_block_const_id&&this.updateWireCoordinates(e,s.id,"to",!0)})),e)))}getTypeInfo(t){return t in default_elements?Object.assign({},default_elements[t]):t in this.state.custom_elements?Object.assign({},this.state.custom_elements[t]):void 0}onBlockStopInitialDragging(t){this.setState((e=>(e.blocks[t].dragging=!1,e)))}getSaveData(){return{name:this.state.name,scale:this.state.scale,offset:this.state.offset,custom_elements:this.state.custom_elements,new_element:this.state.new_element,inputs_number:this.state.inputs_number,outputs_number:this.state.outputs_number,blocks:this.state.blocks,wires:this.state.wires,tests:this.state.tests}}getSaveName(){const t=new Date,e=t.getFullYear().toString()+"-"+(t.getMonth()+1).toString()+"-"+t.getDate().toString(),s=t.getHours()+":"+t.getMinutes()+":"+t.getSeconds();return"logic-scheme-"+this.state.name+"-"+e+"-"+s+".json"}save(){const t=this.getSaveData(),e=JSON.stringify(t,null,"\t"),s=this.getSaveName();downloadFile(s,e)}setLoadData(t){this.clear(void 0,(()=>this.setState(t)))}load(){uploadFile("json",(t=>{const e=JSON.parse(t);this.setLoadData(e)}))}getExportData(){const t=this.state.blocks,e=this.state.tests,s=[];Object.values(this.state.wires).forEach((e=>{const n=t[e.from_block_const_id],o=t[e.to_block_const_id],i=n.outputs_groups[e.from_output_id],a=t[e.from_block_const_id].type,r=t[e.to_block_const_id].type,u=t[e.from_block_const_id].outputs_groups.slice(0,e.from_output_id),l=sum(u),c=t[e.to_block_const_id].inputs_groups.slice(0,e.to_input_id),p=sum(c);for(let t=0;t<i;t++){const e=l+t,i=p+t,u={};if("INPUT"==a&&n.id.includes("-")){const e=n.id.split(" ")[1].split("-"),s=Number.parseInt(e[0],10);u.from="INPUT_"+(s+t)+"[1]"}else{const t=n.id.split(" ");u.from=t[0]+"_"+t[1]+"["+(e+1)+"]"}if("OUTPUT"==r&&o.id.includes("-")){const e=o.id.split(" ")[1].split("-"),s=Number.parseInt(e[0],10);u.to="OUTPUT_"+(s+t)+"[1]"}else{const t=o.id.split(" ");u.to=t[0]+"_"+t[1]+"["+(i+1)+"]"}s.push(u)}}));const n={[this.state.name]:{wires:s}};return e.length>0&&(n[this.state.name].tests=e.map((t=>({inputs:t.slice(0,this.state.inputs_number),outputs:t.slice(-this.state.outputs_number)})))),n}getExportName(){return this.state.name+".json"}export(){const t=this.getExportData(),e=JSON.stringify(t,null,"\t"),s=this.getExportName();downloadFile(s,e)}handleMouseDown(t,e,s){0==t.button&&this.add({blocks:[Object.assign(deepCopy(s),{type:e,x:t.clientX,y:t.clientY,dragging:!0})]})}handleBlockMouseDown(t,e,s,n,o){if(2===n)return void t.state.removeBlock();this.setState({dragging_block:!0});const i=t._ref.current.parentElement.getBoundingClientRect(),a=this.state.scale;t.setState((t=>(t.dragging=!0,t.gripX=(e-i.x)/a-t.x,t.gripY=(s-i.y)/a-t.y,t)),o)}handleMouseDownOnSchemeArea(t){if(!t.target.classList.contains("schemeArea"))return;const e=t.clientX,s=t.clientY;this.setState((t=>({dragging_scheme:!0,dragging_scheme_from_point:{x:e-t.offset.x,y:s-t.offset.y}})))}handleMouseMove(t){const e=t.clientX,s=t.clientY;if(this.state.dragging_scheme)this.setState((t=>({offset:{x:e-t.dragging_scheme_from_point.x,y:s-t.dragging_scheme_from_point.y}})));else if(this.state.adding_wire_info){const t=this.state.blocks_wrapper_ref.current.getBoundingClientRect();null==this.state.adding_wire_info.from_block_const_id?this.setState((n=>(n.adding_wire_info.from_point={x:e-t.x,y:s-t.y},n))):this.setState((n=>(n.adding_wire_info.to_point={x:e-t.x,y:s-t.y},n)))}}handleBlockMouseMove(t,e,s){const n=t._ref.current.parentElement.getBoundingClientRect(),o=this.state.scale;!0===t.state.dragging&&t.setState((t=>(t.x=(e-n.x)/o-t.gripX,t.y=(s-n.y)/o-t.gripY,t)),(()=>t.state.onStateChange(t.getInfo(t.state))))}handleMouseUp(){this.setState({adding_wire:!1,dragging_block:!1,dragging_scheme:!1,dragging_scheme_from_point:void 0})}handleMouseUpOnInputOutput(t){if(!this.state.adding_wire)return;if(this.state.adding_wire_info.group_size!=t.group_size)return;const e=Object.assign({},this.state.adding_wire_info);this.setState({adding_wire_info:void 0});for(const s in t)e[s]=t[s];"to_block_const_id"in e&&"from_block_const_id"in e&&e.to_block_const_id!=e.from_block_const_id&&(delete e.from_point,delete e.to_point,this.add({wires:[e]}))}removeBlock(t){this.setState((e=>{const s=e.blocks[t].type,n=e.blocks[t].id;Number.parseInt(n.split(" ").pop(),10);let o;return e.wires=Object.fromEntries(Object.entries(e.wires).filter((([e,s])=>s.from_block_const_id!=t&&s.to_block_const_id!=t))),"INPUT"==s?(o=-sum(e.blocks[t].getOutputsGroups()),e.inputs_number+=o):"OUTPUT"==s?(o=-sum(e.blocks[t].getInputsGroups()),e.outputs_number+=o):o=-1,delete e.blocks[t],this.shiftBlocksIds(e,s,t,o),e}))}updateInputsOutputsNames(t,e,s){this.setState((n=>{const o=n.blocks[e].id.split(" ")[1];let i;if(o.includes("-")){const t=o.split("-"),e=Number.parseInt(t[0],10),n=Number.parseInt(t[1],10);i=n+s==e?""+e:e+"-"+(n+s)}else{const t=Number.parseInt(o,10);i=t+"-"+(t+s)}return n.blocks[e].id=t+" "+i,this.shiftBlocksIds(n,t,e,s),"INPUT"==t?n.inputs_number+=s:(t="OUTPUT")&&(n.outputs_number+=s),n}))}shiftBlocksIds(t,e,s,n){for(const o in t.blocks)if(t.blocks[o].type==e&&t.blocks[o].const_id>s){const s=t.blocks[o].id.split(" ")[1];let i;if(s.includes("-")){const t=s.split("-");i=Number.parseInt(t[0],10)+n+"-"+(Number.parseInt(t[1],10)+n)}else{i=""+(Number.parseInt(s,10)+n)}const a=e+" "+i;t.blocks[o].setId(a),t.blocks[o].id=a}}startAddingWire(t){this.setState({adding_wire:!0,adding_wire_info:t})}removeWires(t){this.setState((e=>(e.wires=Object.fromEntries(Object.entries(e.wires).filter((([e,s])=>{for(const e in t)if(t[e]!=s[e])return!0;return!1}))),e)))}handleMouseWheel(t){const e=1+-Math.sign(t.deltaY)/10,s=t.clientX,n=t.clientY;this.setState((t=>(t.scale*=e,t.offset.x-=(e-1)*(s-t.offset.x),t.offset.y-=(e-1)*(n-t.offset.y),t)))}handleAddBlockButtonClick(){const t=this.state.new_element.type;this.setState((e=>(this.state.custom_elements[t]=deepCopy(this.state.new_element),e)))}clear(t,e){this.setState({blocks:{},wires:{},inputs_number:0,outputs_number:0,tests:[]},(()=>e?e():void 0))}wireHere(t,e,s){return Object.values(this.state.wires).some((n=t,o=e,i=s,t=>"output"==o&&n==t.from_block_const_id&&i==t.from_output_id||"input"==o&&n==t.to_block_const_id&&i==t.to_input_id));var n,o,i}render(){const t=this.state.scale,e=this.state.offset,s=this.state.inputs_number,n=this.state.outputs_number,o=this.state.tests.length,i=2**s;return h("div",{className:"blocksArea",ref:this._ref},h("div",{className:"sidePanel",style:{zIndex:10,display:this.state.dragging_block?"none":"block"}},h("div",{className:"controls"},h("input",{type:"text",className:"schemeName unselectable",value:this.state.name,onChange:t=>this.setState({name:t.target.value})}),h("button",{className:"exportButton animated animated-lightblue unselectable",onClick:this.export},"export"),h("button",{className:"saveButton animated animated-green unselectable",onClick:this.save},"save"),h("button",{className:"loadButton animated animated-blue unselectable",onClick:this.load},"load"),h("button",{className:"clearButton animated animated-red unselectable",onClick:this.clear},"clear")),h("div",{className:"tests"},s>0&&n>0?h("div",{className:"coverageInfo unselectable",id:o+" "+i},"Coverage:",h("br",null),o,"/",i," (",Math.floor(o/i*100),"%)"):null,h("button",{className:"editTestsButton animated animated-lightblue unselectable",onClick:()=>this.setState({tests_editor_opened:!0})},"edit tests")),h("div",{className:"newBlockConfiguration"},h("div",{className:"block blockToAdd",onMouseDown:t=>this.handleMouseDown(t,this.state.new_element.type,this.state.new_element)},h("div",{className:"content"},h("input",{type:"text",className:"name",value:this.state.new_element.type,onChange:t=>this.setState((e=>(e.new_element.type=t.target.value,e))),onMouseDown:t=>t.stopPropagation()}))),h("div",{className:"inputsOutputsNumber"},h("div",{className:"inputsNumber"},h("input",{type:"number",min:"1",ref:this.inputs_number_ref,value:this.state.new_element.inputs.length,onChange:t=>this.setState((e=>{const s=numberOr(t.target.value,1);return e.new_element.inputs=filledArray(s,""),e.new_element.inputs_groups=cutToSum(e.new_element.inputs_groups,s),e}))})),h("div",{className:"outputsNumber"},h("input",{type:"number",min:"1",ref:this.outputs_number_ref,value:this.state.new_element.outputs.length,onChange:t=>this.setState((e=>{const s=numberOr(t.target.value,1);return e.new_element.outputs=filledArray(s,""),e.new_element.outputs_groups=cutToSum(e.new_element.outputs_groups,s),e}))}))),h("div",{className:"inputsOutputsGroups"},h("div",{className:"inputsGroups"},this.state.new_element.inputs_groups.map(((t,e)=>h("div",{key:e,className:"inputGroup unselectable",onMouseDown:t=>{let s;if(0==t.button)s=joinWithNext;else{if(2!=t.button)return state;s=unjoinToNext}this.setState((t=>(t.new_element.inputs_groups=s(t.new_element.inputs_groups,e),t)))},onContextMenu:t=>t.preventDefault()},t)))),h("div",{className:"outputsGroups"},this.state.new_element.outputs_groups.map(((t,e)=>h("div",{key:e,className:"outputGroup unselectable",onMouseDown:t=>{let s;if(0==t.button)s=joinWithNext;else{if(2!=t.button)return state;s=unjoinToNext}this.setState((t=>(t.new_element.outputs_groups=s(t.new_element.outputs_groups,e),t)))},onContextMenu:t=>t.preventDefault()},t))))),h("button",{className:"addBlockButton animated animated-green unselectable",onClick:this.handleAddBlockButtonClick},"+")),h("div",{className:"blocks"},Object.entries(this.state.custom_elements).map(((t,e)=>h("div",{key:t[0],className:"block",onMouseDown:e=>this.handleMouseDown(e,t[0],t[1])},h("div",{className:"content"},h("div",{className:"name unselectable"},t[0]))))),Object.entries(default_elements).map(((t,e)=>h("div",{key:t[0],className:"block",onMouseDown:e=>this.handleMouseDown(e,t[0],t[1])},h("div",{className:"content"},h("div",{className:"name unselectable"},t[0]))))))),this.state.tests_editor_opened?h(ModalWindow,{close_function:()=>this.setState({tests_editor_opened:!1})},h(TestsEditor,{inputs:Array.from({length:s},((t,e)=>e+1)),outputs:Array.from({length:n},((t,e)=>e+1)),tests:this.state.tests.map((t=>t.slice(0,s).concat(t.slice(-n)))),onUnmount:t=>this.setState({tests:t})})):null,h("div",{className:"schemeArea",onWheel:this.handleMouseWheel,onMouseDown:this.handleMouseDownOnSchemeArea,onMouseMove:this.handleMouseMove,onMouseUp:this.handleMouseUp,onContextMenu:t=>t.preventDefault()},h("div",{className:"blocksWrapper",ref:this.state.blocks_wrapper_ref,style:{left:e.x,top:e.y,transform:"scale("+t+")"}},Object.entries(this.state.blocks).map(((t,e)=>h(Block,{key:"INPUT"==t[1].type||"OUTPUT"==t[1].type?t[0]+" "+t[1].id:t[0],const_id:t[1].const_id,id:t[1].id,type:t[1].type,x:t[1].x,y:t[1].y,scale:this.state.scale,handleMouseMove:this.handleBlockMouseMove.bind(this),handleMouseDown:this.handleBlockMouseDown.bind(this),dragging:t[1].dragging,inputs:t[1].inputs,outputs:t[1].outputs,inputs_groups:t[1].inputs_groups,outputs_groups:t[1].outputs_groups,removeBlock:()=>this.removeBlock(t[0]),startAddingWire:this.startAddingWire,handleMouseUpOnInputOutput:this.handleMouseUpOnInputOutput,removeWires:this.removeWires,onMount:this.onBlockMounted,onStateChange:this.onBlockStateChange,onStopInitialDragging:this.onBlockStopInitialDragging,updateInputsOutputsNames:this.updateInputsOutputsNames.bind(this),wireHere:this.wireHere.bind(this),getTypeInfo:this.getTypeInfo.bind(this)}))),Object.values(this.state.wires).map((e=>h(Wire,{key:e.from_point.x+" "+e.from_point.y+" "+e.to_point.x+" "+e.to_point.y,from_point:e.from_point,to_point:e.to_point,scale:t}))),this.state.adding_wire_info?h(Wire_f,{from_point:scalePoint(this.state.adding_wire_info.from_point,1/t),to_point:scalePoint(this.state.adding_wire_info.to_point,1/t),scale:t}):null)))}}